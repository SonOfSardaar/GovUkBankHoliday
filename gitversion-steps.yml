parameters:
  - name: gitVersionSpec
    default: 5.x
  
steps:
  - checkout: self
    fetchDepth: 0
  - pwsh: |
      $file = "GitVersion.yml"
      if(Test-Path -Path $file -PathType Leaf){
          Write-Host "$file already exists. Skipping"
      }
      else
      {
          function AddContent($content){ Add-Content $file $content }
        
          Write-Host "Creating $file"
  
          AddContent "mode: ContinuousDelivery"
          AddContent "next-version: 1.0.0"
          AddContent "branches:"
          AddContent " main:"
          AddContent "  regex: ^main"
          AddContent "  tag: ''"
          AddContent "  increment: Patch"
          AddContent "  is-mainline: true"
          AddContent " feature:"
          AddContent "  regex: ^feature?[/-]"
          AddContent "  tag: alpha"
          AddContent " hotfix:"
          AddContent "  regex: ^hotfix?[/-]"
          AddContent "  tag: fix"
          AddContent "ignore:"
          AddContent " sha: []"
          AddContent "merge-message-formats: {}"
      }
    displayName: Create Gitversion Config
  
  - task: gitversion/setup@0    
    displayName: Setup GitVersion        
    inputs:
      versionSpec: ${{parameters.gitVersionSpec}}
  
  - task: gitversion/execute@0
    displayName: Execute GitVersion
  
  - pwsh: |
      $version = "$(Build.BuildNumber)" -replace "\+", "."
      Write-Host "##vso[build.updatebuildnumber]$version"
    displayName: Clean Build Number